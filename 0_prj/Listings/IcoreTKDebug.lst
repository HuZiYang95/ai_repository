C51 COMPILER V9.59.0.0   ICORETKDEBUG                                                      08/29/2024 16:47:02 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE ICORETKDEBUG
OBJECT MODULE PLACED IN .\Objects\IcoreTKDebug.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\1_bsp\IcoreTKDebug.c OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(..\1_bsp;..
                    -\2_hal;..\3_app;..\4_user) DEBUG PRINT(.\Listings\IcoreTKDebug.lst) OBJECT(.\Objects\IcoreTKDebug.obj)

line level    source

   1          
   2          #include "TouchKeyCTC.h"
   3          #include "IcoreTKDebug.h"
   4          
   5          
   6          
   7          
   8          /*******************************é€šä¿¡å‚æ•°*************************************/
   9          #define WriteDeviceAddress 0xa0
  10          #define ReadDviceAddress 0xa1
  11          #define  Data_ADDR    0X00
  12          #define   C_SlaveAddr    0x28
  13          #define   C_FrameHeader  0x55AA
  14          /***************************************************************************/
  15          
  16          
  17          ///*******************************é€šä¿¡å¼•è„šP10 P11*******************************/
  18          #define   Port_I2CSCL   P10                               //é€šä¿¡SCLå£ï¼Œè¿žæŽ¥åˆ°ä»¿çœŸå™¨SCK
  19          #define   Port_I2CSDA   P11                               //é€šä¿¡SDAå£ï¼Œ è¿žæŽ¥åˆ°ä»¿çœŸå™¨SDA
  20          #define   Port_I2CSDA_SETIN    P1IO &= 0XFD;P1PU |= 0x02; //å°†é€šä¿¡SDAå£è®¾ç½®ä¸ºè¾“å…¥ï¼Œå¹¶å¼€å¯è¯¥ç
             -«¯å£ä¸Šæ‹‰ç”µé˜»
  21          #define   Port_I2CSDA_SETOUT   P1IO |= 0X02;              //å°†é€šä¿¡SDAç«¯å£é…ç½®ä¸ºè¾“å‡º
  22          #define   Port_I2CSCL_SETOUT   P1IO |= 0X01;               //å°†é€šä¿¡SCLç«¯å£é…ç½®ä¸ºè¾“å‡º
  23          /***************************************************************************/
  24          
  25          
  26          
  27          /*******************************é€šä¿¡æ—¶åº************************************/
  28          #if TK_DEBUG_ENABLE
              
              /*************å˜é‡å®šä¹‰*****************/
              unsigned char r1ms_tkFrame;
              
              /*************å‡½æ•°å£°æ˜Ž*****************/
              void TK_FrameSender(unsigned int *tkData1, unsigned int *tkData2, unsigned char DataSize);
              
              /*************å‡½æ•°å®šä¹‰*****************/
              void I2C_Wait_uSec(unsigned char  num)
              {
                      while (num--);
              }
              
              
              /***************************************************************************/
              void I2C_Start()
              {
                      Port_I2CSDA = 1;
                      Port_I2CSCL = 1;
                      I2C_Wait_uSec(20);
                      Port_I2CSDA = 0;
                      I2C_Wait_uSec(200);
                      Port_I2CSCL = 0;
              }
              
C51 COMPILER V9.59.0.0   ICORETKDEBUG                                                      08/29/2024 16:47:02 PAGE 2   

              /***************************************************************************/
              void I2C_Stop()
              {
                      Port_I2CSCL = 0;
                      I2C_Wait_uSec(200);
                      Port_I2CSDA = 0;
                      I2C_Wait_uSec(200);
                      Port_I2CSCL = 1;
                      I2C_Wait_uSec(200);
                      Port_I2CSDA = 1;
              }
              
              /***************************************************************************/
              //void I2C_Ack()
              //{
              //      Port_I2CSDA = 0;
              //      I2C_Wait_uSec(200);
              //      Port_I2CSCL = 1;
              //      I2C_Wait_uSec(200);
              //      Port_I2CSCL = 0;
              //      I2C_Wait_uSec(200);
              //      Port_I2CSDA = 1;
              //}
              
              /***************************************************************************/
              //void I2C_NoAck()
              //{
              //      Port_I2CSDA = 1;
              //      I2C_Wait_uSec(200);
              //      Port_I2CSCL = 1;
              //      I2C_Wait_uSec(200);
              //      Port_I2CSCL = 0;
              //}
              
              /***************************************************************************/
              bit TestAck()
              {
                      bit ErrorBit;
                      Port_I2CSDA_SETIN;
                      I2C_Wait_uSec(20);
                      Port_I2CSCL = 1;
                      I2C_Wait_uSec(20);
                      ErrorBit = Port_I2CSDA;
                      Port_I2CSCL = 0;
                      Port_I2CSDA_SETOUT;
              
                      return(ErrorBit);
              }
              
              /***************************************************************************/
              void Write_Byte(unsigned char input)
              {
                      unsigned char temp;
                      for (temp = 8;temp > 0;temp--)
                      {
                              Port_I2CSDA = (bit)(input & 0x80);
                              I2C_Wait_uSec(10);
                              Port_I2CSCL = 1;
                              I2C_Wait_uSec(10);
                              Port_I2CSCL = 0;
                              input = input << 1;
                      }
C51 COMPILER V9.59.0.0   ICORETKDEBUG                                                      08/29/2024 16:47:02 PAGE 3   

                      I2C_Wait_uSec(10);
                      TestAck();
              }
              
              
              
              
              
              void   Frame_SendStart(PackHeader _packHeader)
              {
                      unsigned char _checkSum = 0;
                      unsigned char _i;
                      unsigned char *_bufPoint;
              
                      _bufPoint = (unsigned char *)&_packHeader;
                      I2C_Start();
                      for (_i = 0;_i < sizeof(_packHeader);_i++, _bufPoint++)
                      {
                              Write_Byte(*_bufPoint);
                      }
              }
              
              
              unsigned char Frame_SendData(PackStrcut _packStrcut)
              {
                      unsigned char _checkSum = 0;
                      unsigned char _i;
                      unsigned char *_bufPoint;
              
                      _bufPoint = (unsigned char *)&_packStrcut;
                      for (_i = 0;_i < sizeof(_packStrcut);_i++, _bufPoint++)
                      {
                              Write_Byte(*_bufPoint);
                              _checkSum += *_bufPoint;
                      }
                      return _checkSum;
              }
              
              
              /*******************************************************************************
              * å‡½æ•°å:TK_FrameSender
              * åŠŸ  èƒ½ : æ•°æ®å‘é€
               * è¿”å›žå€¼ï¼šæ— 
               * å‚  æ•°ï¼šæ— 
               ******************************************************************************/
              
              
              void TK_FrameSender(unsigned int *tkData1, unsigned int *tkData2, unsigned char DataSize)
              {
                      PackHeader packHeader;
                      PackStrcut packStrcut;//
                      unsigned char checksum = 0;
                      unsigned char i;
                      Port_I2CSDA_SETOUT                //å°†é€šä¿¡SDAç«¯å£é…ç½®ä¸ºè¾“å‡º
                              Port_I2CSCL_SETOUT                //å°†é€šä¿¡SCLç«¯å£é…ç½®ä¸ºè¾“å‡º        //P10 P11è¾“å‡ºä½œä¸ºé€šä¿¡
             -å¼•è„š
                              packHeader.Slave_Addr = C_SlaveAddr;
                      packHeader.Frame_Header = C_FrameHeader;
                      packHeader.length = sizeof(packStrcut) * DataSize + 2;        //é•¿åº¦=æ•°æ®é•¿åº¦(1)+æŒ‰é”®æ•°æ®(6*X)+
             -æ ¡éªŒç (1)
                      checksum = (unsigned char)(packHeader.length);   //æ ¡éªŒç ä¸ºé™¤ä»Žæœºåœ°å€å’Œ0X55AAå¤–çš„æ‰€æœ‰æ•°æ®
             -ä¹‹å’Œ
C51 COMPILER V9.59.0.0   ICORETKDEBUG                                                      08/29/2024 16:47:02 PAGE 4   

                      Frame_SendStart(packHeader);
                      for (i = 0;i < DataSize;i++)
                      {
                              packStrcut.debug_baseLine = *(tkData1 + i);
                              packStrcut.debug_rawData = *(tkData2 + i);
                              packStrcut.debug_noiseData = abs(*(tkData1 + i) - *(tkData2 + i));  //
              
                              checksum += Frame_SendData(packStrcut);
              
                      }
                      Write_Byte(checksum);//å‘é€æ ¡éªŒå’Œ
                      I2C_Stop();
              
              }
              
              
              #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   ----    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
