#include "../1_bsp/bsp_adc.h"
#include "../1_bsp/typedef.h"
#include "ntc_vdd_check.h"

// NTC?????????
typedef struct
    {
    u16 buffer[NTC_SAMPLE_COUNT];  // ??????????
    u8 index;                      // ???§Õ??¦Ë??
    u8 ready;                      // ??????????
    u16 result;                    // ??????
    } NTC_SampleData;

// VDD?????????
typedef struct
    {
    u16 raw;            // ???????
    float voltage;      // ?????????
    } VDD_SampleData;

static NTC_SampleData ntc_data = { 0 };
static VDD_SampleData vdd_data = { 0 };

// ???????????
static void ntc_sample_process(void);
static void vdd_sample_process(void);
static void sort_array(u16* arr, u8 len);

/**
 * @brief ?????ADC???
 */
void ntc_vdd_init(void)
    {
    // ?????NTC??ADC????????10??VDD?¦Ï??????
    bsp_adc_init(ADC_CHAN_10, ADC_FREQ_DIV_8, ADC_VREF_VDD);
    }

/**
 * @brief NTC???????????10ms??????¦²?
 */
static void ntc_sample_process(void)
    {
    // ??????????
    u16 raw = bsp_adc_get_raw();
    if (raw == 0xFFFF) return;  // ??§¹????

    // ?›¥?????
    ntc_data.buffer[ntc_data.index++] = raw;

    // ??10?¦Â???????
    if (ntc_data.index >= NTC_SAMPLE_COUNT)
        {
        ntc_data.index = 0;
        ntc_data.ready = 1;

        // ????????????????????
        u16 temp[NTC_SAMPLE_COUNT];
        memcpy(temp, ntc_data.buffer, sizeof(temp));
        sort_array(temp, NTC_SAMPLE_COUNT);

        // ????¦Â???????
        u32 sum = 0;
        for (u8 i = 1; i < NTC_SAMPLE_COUNT - 1; i++)
            {
            sum += temp[i];
            }
        ntc_data.result = sum / (NTC_SAMPLE_COUNT - 2);
        }
    }

/**
 * @brief VDD???????????20ms??????¦²?
 */
static void vdd_sample_process(void)
    {
    // ?§Ý?????????VDD??????
    bsp_adc_switch_channel(ADC_CHAN_1_4_vdd);
    NOP();NOP();NOP();NOP();NOP();  // ?????????

    // ????????
    u16 raw = bsp_adc_get_raw();
    if (raw == 0xFFFF) return;

    // ???????????????12¦ËADC??Vref=VDD??
    // ????§à?????????VDD = (raw * Vref) / 4095
    // ????????1/4??????????????VDD = (raw * 4.0f) / 4095 * Vref
    // ??Vref=VDD????????????VDD = (raw * 4.0f) / 4095 * VDD ?? ????????????
    // ????????????????VDD = (4095 * 1.2V) / raw ?????????1.2V?????
    vdd_data.raw = raw;
    vdd_data.voltage = (4095.0f * 1.2f) / raw;  // ??????????§à??????????
    }

/**
 * @brief ?????????????????1ms????§Ø??§Ö????
 */
void ntc_vdd_timer_handler(void)
    {
    static u16 tic_10ms = 0;
    static u16 tic_20ms = 0;

    if (++tic_10ms >= 10)
        {
        tic_10ms = 0;
        ntc_sample_process();
        }

    if (++tic_20ms >= 20)
        {
        tic_20ms = 0;
        vdd_sample_process();
        }
    }

/**
 * @brief ???NTC?????
 */
u16 get_ntc_result(void)
    {
    ntc_data.ready = 0;
    return ntc_data.result;
    }

/**
 * @brief ???VDD????
 */
float get_vdd_voltage(void)
    {
    return vdd_data.voltage;
    }

/**
 * @brief ?????????
 */
static void sort_array(u16* arr, u8 len)
    {
    for (u8 i = 0; i < len - 1; i++)
        {
        for (u8 j = 0; j < len - 1 - i; j++)
            {
            if (arr[j] > arr[j + 1])
                {
                u16 temp = arr[j];
                arr[j] = arr[j + 1];
                arr[j + 1] = temp;
                }
            }
        }
    }
